name: Prepare Release

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version Bump Type'
        required: true
        default: 'minor'
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  prepare:
    runs-on: ubuntu-x64
    steps:
      - name: Get secrets
        uses: grafana/shared-workflows/actions/get-vault-secrets@39e279fe6459506c696fa5887a0a6ea012b30727
        with:
          repo_secrets: |
            GITHUB_APP_ID=pyroscope-development-app:app-id
            GITHUB_APP_PRIVATE_KEY=pyroscope-development-app:app-private-key

      - name: Generate GitHub token
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2
        id: app-token
        with:
          app-id: ${{ env.GITHUB_APP_ID }}
          private-key: ${{ env.GITHUB_APP_PRIVATE_KEY }}

      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          token: ${{ steps.app-token.outputs.token }}
          persist-credentials: true

      - name: Bump Version
        id: bump_version
        env:
          VERSION_BUMP: ${{ inputs.version_bump }}
        run: |
          current_version=$(grep 'pyroscope_version=' gradle.properties | cut -d'=' -f2)
          echo "Current version: $current_version"
          IFS='.' read -r major minor patch <<< "$current_version"

          case "$VERSION_BUMP" in
            "major")
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            "minor")
              minor=$((minor + 1))
              patch=0
              ;;
            "patch")
              patch=$((patch + 1))
              ;;
          esac

          new_version="${major}.${minor}.${patch}"
          echo "New version: $new_version"

          sed -i "s/pyroscope_version=.*/pyroscope_version=$new_version/" gradle.properties
          echo "version=$new_version" >> $GITHUB_OUTPUT

      - name: Get GitHub App User ID
        id: get-user-id
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          APP_SLUG: ${{ steps.app-token.outputs.app-slug }}
        run: |
          APP_BOT="${APP_SLUG}[bot]"
          echo "user-id=$(gh api "/users/${APP_BOT}" --jq .id)" >> "$GITHUB_OUTPUT"

      - name: Create Release Branch and PR
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          APP_SLUG: ${{ steps.app-token.outputs.app-slug }}
          USER_ID: ${{ steps.get-user-id.outputs.user-id }}
          VERSION: ${{ steps.bump_version.outputs.version }}
        run: |
          APP_BOT="${APP_SLUG}[bot]"
          git config --global user.name "${APP_BOT}"
          git config --global user.email "${USER_ID}+${APP_BOT}@users.noreply.github.com"

          BRANCH="release/v${VERSION}"
          git checkout -b "${BRANCH}"
          git add gradle.properties
          git commit -m "version ${VERSION}"
          git push origin "${BRANCH}"

          gh pr create \
            --base main \
            --head "${BRANCH}" \
            --title "Release v${VERSION}" \
            --body "Automated release PR for version ${VERSION}.

          Once this PR is merged, the release-publish workflow will automatically:
          - Build and publish artifacts to Maven Central
          - Create the v${VERSION} tag
          - Create a GitHub release"
